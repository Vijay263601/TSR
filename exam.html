<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Exam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f1f5f9;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 12px;
}

.hidden { display: none; }

h2 { text-align: center; }

input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border-radius: 6px;
  border: 1px solid #cbd5f5;
}

.timer {
  color: #dc2626;
  font-weight: bold;
}

.option {
  padding: 12px;
  border: 1px solid #cbd5f5;
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
}

.option.selected {
  background: #2563eb;
  color: white;
}

button {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  background: #2563eb;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

button.secondary {
  background: #64748b;
  margin-right: 8px;
}
</style>
</head>

<body>

<!-- ================= STUDENT DETAILS ================= -->
<div class="container" id="studentForm">
  <h2>Student Details</h2>
  <input id="nameInput" placeholder="Full Name">
  <input id="emailInput" type="email" placeholder="Email">
  <input id="rollInput" placeholder="Roll Number">
  <button onclick="startExam()">Start Exam</button>
</div>

<!-- ================= EXAM PAGE ================= -->
<div class="container hidden" id="examPage">
  <div>
    Exam ID: <span id="examIdText"></span>
    <span class="timer" id="timer"></span>
  </div>

  <h3 id="questionText">Loading...</h3>
  <div id="options"></div>

  <button class="secondary" onclick="prev()">Previous</button>
  <button onclick="next()">Next</button>
  <button onclick="submitExam()">Submit</button>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbwjJOddOUeAVGVtTg4ANfaPeXty0KriN9ruhcKbkQnwN-mQWO9BYaaEGn81Tfp5htmF6g/exec";
/* ========================================= */

const examId = new URLSearchParams(window.location.search).get("examId");
document.getElementById("examIdText").textContent = examId;

/* ---------- DOM ---------- */
const studentForm = document.getElementById("studentForm");
const examPage = document.getElementById("examPage");
const questionText = document.getElementById("questionText");
const optionsDiv = document.getElementById("options");
const timerEl = document.getElementById("timer");

const nameInput = document.getElementById("nameInput");
const emailInput = document.getElementById("emailInput");
const rollInput = document.getElementById("rollInput");

/* ---------- STATE ---------- */
let questions = [];
let answers = {};
let current = 0;
let cheated = false;
let tabSwitches = 0;
let MAX_TAB_SWITCH = 2;
let duration = 0;
let timerInterval;

/* ---------- START EXAM ---------- */
async function startExam() {
  if (!nameInput.value || !emailInput.value || !rollInput.value) {
    alert("Please fill all details");
    return;
  }

  studentForm.classList.add("hidden");
  examPage.classList.remove("hidden");

  const [config, qs] = await Promise.all([
    fetchConfig(),
    fetchQuestions()
  ]);

  duration = config.duration;
  MAX_TAB_SWITCH = config.maxTabSwitch;
  questions = qs;

  renderQuestion();
  startTimer();
}

/* ---------- FETCH CONFIG ---------- */
async function fetchConfig() {
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "GET_EXAM_CONFIG", examId })
  });
  return res.json();
}

/* ---------- FETCH QUESTIONS ---------- */
async function fetchQuestions() {
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "GET_QUESTIONS", examId })
  });
  return res.json();
}

/* ---------- RENDER QUESTION ---------- */
function renderQuestion() {
  const q = questions[current];
  if (!q) return;

  questionText.textContent = `Q${current + 1}. ${q.question}`;
  optionsDiv.innerHTML = "";

  ["A","B","C","D"].forEach(opt => {
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = q[opt];

    if (answers[q.qid] === opt) div.classList.add("selected");

    div.onclick = () => {
      answers[q.qid] = opt;
      document.querySelectorAll(".option")
        .forEach(o => o.classList.remove("selected"));
      div.classList.add("selected");
    };

    optionsDiv.appendChild(div);
  });
}

/* ---------- NAVIGATION ---------- */
function next() {
  if (current < questions.length - 1) {
    current++;
    renderQuestion();
  }
}
function prev() {
  if (current > 0) {
    current--;
    renderQuestion();
  }
}

/* ---------- TIMER ---------- */
function startTimer() {
  let t = duration * 60;
  timerInterval = setInterval(() => {
    timerEl.textContent =
      ` | ${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
    t--;
    if (t < 0) {
      clearInterval(timerInterval);
      submitExam();
    }
  }, 1000);
}

/* ---------- ANTI CHEAT ---------- */
document.addEventListener("visibilitychange", () => {
  if (examPage.classList.contains("hidden")) return;
  if (document.hidden && ++tabSwitches > MAX_TAB_SWITCH) {
    cheated = true;
    submitExam();
  }
});

/* ---------- SUBMIT ---------- */
function submitExam() {
  clearInterval(timerInterval);

  const payload = {
    type: "SUBMIT_RESPONSE",
    examId,
    studentName: nameInput.value,
    email: emailInput.value,
    roll: rollInput.value,
    cheated,
    answers: Object.keys(answers).map(qid => ({
      qid,
      answer: answers[qid]
    }))
  };

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  }).then(() => {
    document.body.innerHTML =
      "<h2 style='text-align:center'>Exam submitted successfully</h2>";
  });
}
</script>

</body>
</html>
