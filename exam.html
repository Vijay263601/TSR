<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Exam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; background:#f1f5f9; padding:20px; }
.container { max-width:800px; margin:auto; background:#fff; padding:25px; border-radius:12px; }
.hidden { display:none; }
input { width:100%; padding:12px; margin:8px 0; }
.option { padding:12px; border:1px solid #cbd5f5; margin-bottom:10px; cursor:pointer; border-radius:8px; }
.option.selected { background:#2563eb; color:#fff; }
.timer { color:#dc2626; font-weight:bold; }
button { padding:10px 16px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; }
button.secondary { background:#64748b; margin-right:8px; }
</style>
</head>

<body>

<!-- STUDENT FORM -->
<div class="container" id="studentForm">
  <h2>Student Details</h2>
  <p><b>Fullscreen is mandatory.</b></p>
  <input id="nameInput" placeholder="Full Name">
  <input id="emailInput" placeholder="Email">
  <input id="rollInput" placeholder="Roll No">
  <button onclick="startExam()">Start Exam</button>
</div>

<!-- EXAM -->
<div class="container hidden" id="examPage">
  <div>Exam ID: <span id="examIdText"></span> <span class="timer" id="timer"></span></div>
  <h3 id="questionText"></h3>
  <div id="options"></div>
  <button class="secondary" onclick="prev()">Previous</button>
  <button onclick="next()">Next</button>
  <button onclick="submitExam()">Submit</button>
</div>

<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbxAFsrjkdWiZV-RICODURcjY7LpDHk9n4Gf8zoqQv6aIviRQM5oHMNIbePyYFaFRB77ng/exec";
const examId = new URLSearchParams(location.search).get("examId");
examIdText.textContent = examId;

/* STATE */
let questions = [], answers = {}, current = 0;
let cheated = false, cheatReason = "";
let examFinished = false;
let duration = 0, MAX_TAB_SWITCH = 2;
let timerInterval, startTime;
let fullscreenActive = false;

/* FULLSCREEN */
function enterFullscreen(){
  const el = document.documentElement;
  return el.requestFullscreen?.() || el.webkitRequestFullscreen?.();
}
function isFullscreen(){
  return document.fullscreenElement || document.webkitFullscreenElement;
}

/* START EXAM */
async function startExam(){
  if(!nameInput.value || !emailInput.value || !rollInput.value){
    alert("Fill all details"); return;
  }

  try {
    await enterFullscreen();
    fullscreenActive = true;
  } catch {
    alert("Fullscreen required"); return;
  }

  studentForm.classList.add("hidden");
  examPage.classList.remove("hidden");

  // âš¡ FAST: parallel fetch
  const [cfg, qs] = await Promise.all([
    fetch(API_URL,{method:"POST",body:JSON.stringify({type:"GET_EXAM_CONFIG",examId})}).then(r=>r.json()),
    fetch(API_URL,{method:"POST",body:JSON.stringify({type:"GET_QUESTIONS",examId})}).then(r=>r.json())
  ]);

  duration = cfg.duration;
  MAX_TAB_SWITCH = cfg.maxTabSwitch;
  questions = qs;

  startTime = Date.now();
  renderQuestion();
  startTimer();
}

/* RENDER */
function renderQuestion(){
  const q = questions[current];
  if(!q) return;
  questionText.textContent = `Q${current+1}. ${q.question}`;
  options.innerHTML = "";

  ["A","B","C","D"].forEach(o=>{
    const d=document.createElement("div");
    d.className="option"+(answers[q.qid]===o?" selected":"");
    d.textContent=q[o];
    d.onclick=()=>{ answers[q.qid]=o; renderQuestion(); };
    options.appendChild(d);
  });
}
function next(){ if(current<questions.length-1){ current++; renderQuestion(); } }
function prev(){ if(current>0){ current--; renderQuestion(); } }

/* TIMER */
function startTimer(){
  let t=duration*60;
  timerInterval=setInterval(()=>{
    timer.textContent=` | ${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
    if(--t<0){ cheatReason="Time up"; submitExam(); }
  },1000);
}

/* ðŸ”’ ANTI-CHEAT (IGNORES AFTER FINISH) */
document.addEventListener("fullscreenchange",()=>{
  if(examFinished || !fullscreenActive) return;
  if(!isFullscreen()){
    cheated=true; cheatReason="Exited fullscreen"; submitExam();
  }
});
document.addEventListener("visibilitychange",()=>{
  if(examFinished || document.hidden===false) return;
  cheated=true; cheatReason="Tab/app switch"; submitExam();
});

/* SUBMIT */
function submitExam(){
  if(examFinished) return;
  examFinished = true;

  clearInterval(timerInterval);

  const payload = {
    type:"SUBMIT_RESPONSE",
    examId,
    studentName:nameInput.value,
    roll:rollInput.value,
    email:emailInput.value,
    cheated,
    cheatReason,
    timeTaken:Math.floor((Date.now()-startTime)/1000),
    answers:Object.keys(answers).map(qid=>({qid,answer:answers[qid]}))
  };

  fetch(API_URL,{method:"POST",body:JSON.stringify(payload)})
  .then(()=>{
    document.body.innerHTML="<h2 style='text-align:center'>Exam submitted successfully</h2>";
    document.exitFullscreen?.();
  });
}
</script>

</body>
</html>
