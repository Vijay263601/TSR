<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Exam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f1f5f9;
  padding: 20px;
}

.container {
  max-width: 800px;
  margin: auto;
  background: white;
  padding: 25px;
  border-radius: 12px;
}

.hidden { display: none; }

.option {
  padding: 12px;
  border: 1px solid #cbd5f5;
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
}

.option.selected {
  background: #2563eb;
  color: white;
}

.timer {
  color: red;
  font-weight: bold;
}

button {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  background: #2563eb;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
button.secondary { background: #64748b; }
</style>
</head>

<body>

<!-- STUDENT DETAILS -->
<div class="container" id="studentForm">
  <h2>Student Details</h2>
  <input id="name" placeholder="Full Name"><br><br>
  <input id="email" placeholder="Email"><br><br>
  <input id="roll" placeholder="Roll Number"><br><br>
  <button onclick="startExam()">Start Exam</button>
</div>

<!-- EXAM -->
<div class="container hidden" id="examPage">
  <div>
    Exam ID: <span id="examIdText"></span>
    <span class="timer" id="timer"></span>
  </div>

  <h3 id="questionText"></h3>
  <div id="options"></div>

  <button class="secondary" onclick="prev()">Previous</button>
  <button onclick="next()">Next</button>
  <button onclick="submitExam()">Submit</button>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxx_99ST7zyPXUz6I3DLJfcMeUCJgYMQMGww_KadIlwJASSNHJSf4bUknM_2Vz1DD_45g/exec";
/* ========================================= */

const examId = new URLSearchParams(location.search).get("examId");
examIdText.textContent = examId;

/* ---------- STATE ---------- */
let questions = [];
let answers = {};
let current = 0;
let cheated = false;
let tabSwitches = 0;
let MAX_TAB_SWITCH = 2;
let duration = 0;
let timerInterval;

/* ---------- DOM CACHE ---------- */
const examPage = document.getElementById("examPage");
const questionText = document.getElementById("questionText");
const optionsDiv = document.getElementById("options");

/* ---------- START EXAM ---------- */
async function startExam() {
  if (!name.value || !email.value || !roll.value) {
    alert("Fill all details");
    return;
  }

  studentForm.classList.add("hidden");
  examPage.classList.remove("hidden");

  const [config, qs] = await Promise.all([
    fetchConfig(),
    fetchQuestions()
  ]);

  questions = qs;
  duration = config.duration;
  MAX_TAB_SWITCH = config.maxTabSwitch;

  renderQuestion();
  startTimer();
}

/* ---------- FETCH CONFIG ---------- */
async function fetchConfig() {
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "GET_EXAM_CONFIG", examId })
  });
  return res.json();
}

/* ---------- FETCH QUESTIONS ---------- */
async function fetchQuestions() {
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "GET_QUESTIONS", examId })
  });
  return res.json();
}

/* ---------- RENDER QUESTION (FAST) ---------- */
function renderQuestion() {
  const q = questions[current];
  questionText.textContent = `Q${current + 1}. ${q.question}`;
  optionsDiv.innerHTML = "";

  ["A","B","C","D"].forEach(opt => {
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = q[opt];

    if (answers[q.qid] === opt) div.classList.add("selected");

    div.onclick = () => {
      answers[q.qid] = opt;
      document.querySelectorAll(".option").forEach(o => o.classList.remove("selected"));
      div.classList.add("selected");
    };

    optionsDiv.appendChild(div);
  });
}

/* ---------- NAV ---------- */
function next() {
  if (current < questions.length - 1) {
    current++;
    renderQuestion();
  }
}
function prev() {
  if (current > 0) {
    current--;
    renderQuestion();
  }
}

/* ---------- TIMER ---------- */
function startTimer() {
  let t = duration * 60;
  timerInterval = setInterval(() => {
    timer.textContent = ` | ${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
    t--;
    if (t < 0) {
      clearInterval(timerInterval);
      submitExam();
    }
  }, 1000);
}

/* ---------- ANTI CHEAT ---------- */
document.addEventListener("visibilitychange", () => {
  if (examPage.classList.contains("hidden")) return;
  if (document.hidden && ++tabSwitches > MAX_TAB_SWITCH) {
    cheated = true;
    submitExam();
  }
});

/* ---------- SUBMIT ---------- */
function submitExam() {
  clearInterval(timerInterval);

  const payload = {
    type: "SUBMIT_RESPONSE",
    examId,
    studentName: name.value,
    email: email.value,
    roll: roll.value,
    cheated,
    answers: Object.keys(answers).map(qid => ({ qid, answer: answers[qid] }))
  };

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  }).then(() => {
    document.body.innerHTML = "<h2>Exam submitted successfully</h2>";
  });
}
</script>

</body>
</html>
